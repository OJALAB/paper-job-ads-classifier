---
title: "R Notebook"
output: html_notebook
---

```{r}
library(data.table)
library(readxl)
library(stringr)
```

Master prompt

```
Załączone pliki przedstawiają oficjalną klasyfikację zawodów i specjalności w 2023 (więcej znajdziesz tutaj https://psz.praca.gov.pl/rynek-pracy/bazy-danych/klasyfikacja-zawodow-i-specjalnosci). Plik kzis-hiearchy-2023 przedstawia kody zawodów (od 1 do 6 cyfr) według układu hierarchicznego. To są kody, które mnie interesują przy klasyfikacji zawodów. Plik KZis-desc-level-2 określa definicję 2 cyfrowych kodów. Wykorzystaj tę wiedzę przy klasyfikacji ofert pracy do kodów zawodów. Przy odpowiedziach skorzystaj też z oficjalnego słownika dostępnego tutaj: https://psz.praca.gov.pl/rynek-pracy/bazy-danych/klasyfikacja-zawodow-i-specjalnosci/wyszukiwarka-opisow-zawodow/?p_p_id=jobclassificationportlet_WAR_nnkportlet&p_p_lifecycle=0&p_p_state=normal&p_p_mode=view&p_p_col_id=column-1&p_p_col_count=1
```

Prompt dla 100

```
Na podstawie wiedzy z projektu (project knowledge) oraz opisu, który tam podałem dotyczącego klasyfikacji zawodów i specjalności 2023 dla każdego rekordu w załączonym pliku zapisz 3 najbardziej prawdopodobne 6 cyfrowe kody zawodu (struktura: kolumna id_ogl, kod1, kod2, kod3). Wynik ma być w postaci wydruku pliku csv gdzie każdy wiersz odpowiada wierszowi z załączonego pliku. Wydruk ma być zrobiony w odpowiedzi.
```

Kody

```{r}
kzis2023 <- fread("../../../job-ads-datasets/data/kzis-hierarchy-2023.tsv", colClasses = "character") |> setDT()
```

Handcoded 

```{r}
hand <- read_excel("../../../job-ads-datasets/data-raw/hand-coded.xlsx") |> setDT()
hand[is.na(job.title), job.title:=""]
hand[is.na(employer), employer:=""]
hand[is.na(position.level), position.level:=""]
hand[is.na(category), category:=""]
hand[is.na(job.description), job.description:=""]
for_eval <- hand[!is.na(id_ogl) & id_ogl_times == 3, .N, id_ogl]$id_ogl
```

```{r}
fwrite(
  hand[id_ogl %in% for_eval, 
       .(id_ogl, desc = str_c(job.title, employer, position.level, category, job.description, sep =" "))] |>
    unique(),
  "../data-raw/sample-100-for-llm.csv"
)
```

Evaluated by claude.ai

```
Rozumiem. Przeanalizuję każdy rekord w załączonym pliku i przyporządkuję 3 najbardziej prawdopodobne 6-cyfrowe kody zawodu zgodnie z klasyfikacją zawodów i specjalności 2023. Wynik przedstawię w formacie CSV, gdzie każdy wiersz będzie zawierał id_ogl oraz trzy kody zawodów. Oto wynik:
```

```{r}
llm_100 <- fread("../data-raw/sample-100-for-llm-evaluated-updated.csv", colClasses = "character") |> unique()
llm_100[!kod1 %in% kzis2023$class] ## zmyslil 3
llm_100[!kod2 %in% kzis2023$class] ## zmuslil 13
llm_100[!kod3 %in% kzis2023$class] ## zmyslil 8

## w sumie 14 kodów zmyślonych dla 24 ogłoszeń
llm_100 |> 
  melt(id.vars = "id_ogl") |>
  {\(x) x[,.N, value]}() |>
  subset(!value %in% kzis2023$class) |>
  {\(x) x[, .(un=.N, n=sum(N))]}()
```

Evaluation

```{r}
hand[id_ogl %in% evals$id_ogl, .(id_ogl, kod_zawodu, kod_zawodu2, possible_codes)] |>
  melt(id.vars = "id_ogl", value.var = "kod") |>
  na.omit() |>
  {\(x) x[, .(kody = list(unique(value)), kody_n = length(unique(value))), id_ogl]}() |>
  merge(x = _, 
        y = evals,
        by = "id_ogl") -> for_evaluation
```

6 digit codes

```{r}
for_evaluation[kody_n == 1][, .(overlap1=kody[[1]] == kod1,
                                overlap2=kody[[1]] %in% c(kod1,kod2),
                                overlap3=kody[[1]] %in% c(kod1,kod2, kod3)), id_ogl] |>
  {\(x) x[, lapply(.SD, mean), .SDcols = overlap1:overlap3]}()
```

```{r}
for_evaluation[kody_n == 1][, .(overlap1=substr(kody[[1]],1,1) == substr(kod1,1,1),
                                overlap2=substr(kody[[1]],1,1) %in% substr(c(kod1,kod2),1,1),
                                overlap3=substr(kody[[1]],1,1) %in% substr(c(kod1,kod2, kod3),1,1)), id_ogl] |>
  {\(x) x[, lapply(.SD, mean), .SDcols = overlap1:overlap3]}()
```

```{r}
for_evaluation[, .(overlap1=length(intersect(kody[[1]], kod1)) > 0,
                   overlap2=length(intersect(kody[[1]], c(kod1,kod2))) > 0,
                   overlap3=length(intersect(kody[[1]], c(kod1, kod2,kod3))) > 0), id_ogl]
```



CBOP

```{r}
hand[source == "CBOP", .(id_ogl, desc = str_c(job.title, employer, position.level, category, job.description, sep =" "))] |> 
  {\(x) x[, desc:=str_replace_all(desc, regex("\\n{1,}"), " ")]}() -> for_eval_cbop

fwrite(x = for_eval_cbop, file = "../data-raw/sample-cbop-for-llm.csv")
```

Compare to 100

Evaluated by Claude
```{r}
llm_cbop <- fread("../data-raw/sample-cbop-for-llm-evaluated.csv", colClasses = "character")

llm_cbop[!kod1 %in% kzis2023$class] ## zmyslil 8
llm_cbop[!kod2 %in% kzis2023$class] ## zmuslil 26
llm_cbop[!kod3 %in% kzis2023$class] ## zmyslil 14

## w sumie 27 kodów zmyślonych dla 48 ogłoszeń
llm_cbop |> 
  melt(id.vars = "id_ogl") |>
  {\(x) x[,.N, value]}() |>
  subset(!value %in% kzis2023$class) |>
  {\(x) x[, .(n_un=.N, sum=sum(N))]}()

```

## compare to automatic 

